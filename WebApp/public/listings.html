<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Listings</title>
    <link rel="stylesheet" href="css/stylesheet.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
</head>
<body>


<div id="listings">
    <form>
        <input type="text" name="search" placeholder="Search..">
    </form>
    <div class="container">

        <div class="btn-group">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Sort by Price
                    <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a href="#">Low to High</a></li>
                    <li><a href="#">High to Low</a></li>
                </ul>
            </div>
        </div>
        <div class="btn-group">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Sort by Date
                    <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a href="#">Most Recent</a></li>
                    <li><a href="#">Last Posted</a></li>
                </ul>
            </div>
        </div>


        <div class="row">
            <div class="well">
                <h1 class="text-center">LISTINGS</h1>
                <div class="list-group">



                    <div ng-app="viewPost" ng-controller="myCtrl">
                        <div ng-repeat="item in info">

                        <!--post #1-->
                        <a ng-href="/view_post.html?id={{item.ID}}"  class="list-group-item">
                            <div class="media col-md-3">
                                <figure class="pull-left">
                                    <!--data-ng-src="data:image/png;base64,{{item.myImage}}"   height="250" width="300"-->
                                    <div class="media-object img-rounded img-responsive"  id="resampled{{item.num}}"  alt="placehold.it/350x250" ></div>
                                </figure>
                            </div>
                            <div class="col-md-6">
                                <h4 class="list-group-item-heading">{{item.Title}} </h4>
                                <p class="list-group-item-text"> {{item.Description}}
                                </p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h2> ${{item.Price}} <small> {{item.myTag}} </small></h2>
                                <button type="button" class="btn btn-primary btn-lg btn-block">View Full Post</button>
                            </div>
                        </a>

                        </div> <!-- //ng-repeat div-->
                    </div>  <!--//view post div-->


                </div>
            </div>
        </div>
    </div>
</div>


<!--
        <h1>TITLE: {{item.Title}}</h1>
        <h1>Description:{{item.Description}}</h1>
        <h1>Price: ${{item.Price}}</h1>
        <h1>Start Date:</h1>
        <h1>Tags: {{item.myTag}}</h1-->>



<script>
    var app = angular.module('viewPost', []);
    app.controller('myCtrl', function($scope, $http) {
        //const username = getParameterByName('username');
        //const username = cplee;
        $http({
            method: 'GET',
            url: '/v1/posts'
        }).then(function successCallback(response) {
            console.log(response);
            $scope.info = [];
            let arrayText;
            for(var i = 0; i < response.data.length; i++){

//                DELETE ALL
//                $http({
//                    method: 'POST',
//                    url: '/v1/user/delete/' + response.data[i]._id,
//                    data: {_id: response.data[i]._id }
//                }).then(function sucessCallback(response){
//                    console.log("deleted");
//                });

                var arrayBuffer = response.data[i].img.data.data;
                var img = base64ArrayBuffer(arrayBuffer);
                resizeImage(img, i);

                 arrayText = {
                    Title: response.data[i].title,
                    Description: response.data[i].description,
                    Price: response.data[i].price,
                    StartDate: response.data[i].startDate,
                    myTag: response.data[i].tag,
                    ID: response.data[i]._id,
                    vuID: response.data[i].vunetid,
                    num: i //keep track of which listing to post image to

                };
                console.log(arrayText);
                $scope.info.push(arrayText);
            }
            JSON.stringify($scope.info);
        }, function errorCallback(error) {
            console.log(error);
        });
    });


    //Converting function ArrayBuffer to Base64
    //https://gist.github.com/jonleighton/958841
    function base64ArrayBuffer(arrayBuffer) {
        var base64    = '';
        var encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

        var bytes         = new Uint8Array(arrayBuffer);
        var byteLength    = bytes.byteLength;
        var byteRemainder = byteLength % 3;
        var mainLength    = byteLength - byteRemainder;

        var a, b, c, d;
        var chunk;

        // Main loop deals with bytes in chunks of 3
        for (var i = 0; i < mainLength; i = i + 3) {
            // Combine the three bytes into a single integer
            chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2];

            // Use bitmasks to extract 6-bit segments from the triplet
            a = (chunk & 16515072) >> 18 ;// 16515072 = (2^6 - 1) << 18
            b = (chunk & 258048)   >> 12 ;// 258048   = (2^6 - 1) << 12
            c = (chunk & 4032)     >>  6 ;// 4032     = (2^6 - 1) << 6
            d = chunk & 63;               // 63       = 2^6 - 1

            // Convert the raw binary segments to the appropriate ASCII encoding
            base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d]
        }

        // Deal with the remaining bytes and padding
        if (byteRemainder == 1) {
            chunk = bytes[mainLength];

            a = (chunk & 252) >> 2 ;// 252 = (2^6 - 1) << 2

            // Set the 4 least significant bits to zero
            b = (chunk & 3)   << 4; // 3   = 2^2 - 1

            base64 += encodings[a] + encodings[b] + '=='
        } else if (byteRemainder == 2) {
            chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1];

            a = (chunk & 64512) >> 10; // 64512 = (2^6 - 1) << 10
            b = (chunk & 1008)  >>  4;// 1008  = (2^6 - 1) << 4

            // Set the 2 least significant bits to zero
            c = (chunk & 15)    <<  2; // 15    = 2^4 - 1

            base64 += encodings[a] + encodings[b] + encodings[c] + '='
        }


        return base64;
    }

    function resizeImage(imageSRC, i){
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext("2d");

        canvas.width = 250; // target width
        canvas.height = 200; // target height

        var image = new Image();
        image.src = "data:image/png; base64," + imageSRC;

        image.onload = function(e) {
            ctx.drawImage(image,
                    0, 0, image.width, image.height,
                    0, 0, canvas.width, canvas.height
            );
            // create a new base64 encoding
            var resampledImage = new Image();
            resampledImage.src = canvas.toDataURL();
            var id = "resampled" + i;
            document.getElementById(id).appendChild(resampledImage);
        };


    }

</script>

</body>
</html>